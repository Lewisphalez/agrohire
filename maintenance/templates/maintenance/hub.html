{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold mb-0">Maintenance Hub</h2>
    <div>
      <button class="btn btn-outline-secondary btn-sm ms-2" id="refreshBtn" onclick="location.reload()">Refresh</button>
    </div>
  </div>

  <!-- Chart and AI Assistant -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-4 text-center">
          <canvas id="riskChart" width="250" height="200"></canvas>
          <div class="d-flex gap-2 flex-wrap justify-content-center mt-2">
            <div><span class="badge bg-danger">Critical: {{ risk_counts.critical }}</span></div>
            <div><span class="badge bg-warning text-dark">High: {{ risk_counts.high }}</span></div>
            <div><span class="badge bg-info text-dark">Medium: {{ risk_counts.medium }}</span></div>
            <div><span class="badge bg-success">Low: {{ risk_counts.low }}</span></div>
          </div>
          <p class="small text-muted mt-2">Last updated: {{ last_updated|date:"M d, Y H:i" }}</p>
        </div>
        <div class="col-md-8">
            <h5><i class="fas fa-brain me-2"></i>Ask Gemini about an equipment</h5>
            <div class="mb-2">
              <select id="equipSelect" class="form-select">
                <option value="">-- Select equipment --</option>
                {% for e in equipment_list %}
                  <option value="{{ e.id }}">{{ e.name }} â€” {{ e.equipment_type.name|default:"" }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="input-group mb-2">
              <input id="aiQuestion" class="form-control" placeholder="e.g., 'Is this equipment at high risk?'">
              <button id="askBtn" class="btn btn-primary">Ask</button>
            </div>
            <div id="aiAnswer" class="border rounded p-2" style="min-height: 80px; background:#f8f9fa;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Active Alerts <small class="text-danger ms-2">({{ critical_alerts_count }} critical)</small></h5>
    </div>
    <div class="card-body" id="alertsContainer">
      {% for alert in active_alerts %}
          <div class="d-flex justify-content-between align-items-start mb-2 alert {% if alert.alert_type == 'critical' %}alert-danger{% elif alert.alert_type == 'high' %}alert-warning{% else %}alert-secondary{% endif %}">
            <div>
              <strong>{{ alert.equipment.name }}</strong>
              <div class="small">{{ alert.message }}</div>
              <div class="small text-muted">Created: {{ alert.created_at|date:"M d, Y H:i" }}</div>
            </div>
            <div class="text-end">
              <button class="btn btn-sm btn-outline-primary mb-1" data-equip-id="{{ alert.equipment.id }}" onclick="openEquipModal(this)">Details</button>
              <button class="btn btn-sm btn-success mb-1" onclick="ackAlert({{ alert.id }}, this)">Acknowledge</button>
              <button class="btn btn-sm btn-secondary mb-1" onclick="dismissAlert({{ alert.id }}, this)">Dismiss</button>
            </div>
          </div>
      {% empty %}
        <p class="text-center text-muted mb-0">No active alerts ðŸŽ‰</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Equipment Details Modal -->
<div class="modal fade" id="equipmentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="equipmentModalTitle">Equipment Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="equipmentModalBody">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ====== Chart rendering ====== */
(function() {
  const chartData = {{ chart_data|safe }};
  if (chartData && chartData.labels) {
    const ctx = document.getElementById('riskChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: chartData.labels,
        datasets: [{
          data: chartData.values,
          backgroundColor: chartData.colors,
          borderColor: '#fff',
          borderWidth: 1
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }
})();

/* ====== CSRF helper for fetch ====== */
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
const csrftoken = getCookie('csrftoken');

/* ====== AJAX: acknowledge/dismiss alerts ====== */
async function ackAlert(alertId, btn) {
  btn.disabled = true;
  try {
    const res = await fetch(`{% url 'maintenance:acknowledge_alert_ajax' 0 %}`.replace('0', alertId), {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken, 'Accept': 'application/json'}
    });
    const data = await res.json();
    if (data.ok) {
        refreshAlerts();
    } else {
        console.error('Error acknowledging alert:', data.error);
        alert(data.error || 'Error acknowledging');
    }
  } catch (e) { 
    console.error(e); 
    alert('Request failed'); 
  }
}

async function dismissAlert(alertId, btn) {
  btn.disabled = true;
  try {
    const res = await fetch(`{% url 'maintenance:dismiss_alert_ajax' 0 %}`.replace('0', alertId), {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken, 'Accept': 'application/json'}
    });
    const data = await res.json();
    if (data.ok) {
        refreshAlerts();
    } else {
        console.error('Error dismissing alert:', data.error);
        alert(data.error || 'Error dismissing');
    }
  } catch (e) { 
    console.error(e); 
    alert('Request failed'); 
  }
}

/* ====== Open equipment modal (AJAX fetch details) ====== */
function openEquipModal(button) {
  const equipId = button.getAttribute('data-equip-id');
  const modalEl = document.getElementById('equipmentModal');
  const modal = new bootstrap.Modal(modalEl);
  const body = document.getElementById('equipmentModalBody');
  const title = document.getElementById('equipmentModalTitle');
  body.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
  title.textContent = 'Loading...';
  modal.show();

  fetch(`{% url 'maintenance:equipment_detail_json' 0 %}`.replace('0', equipId))
    .then(r => r.json())
    .then(json => {
      if (!json.ok) {
        body.innerHTML = `<div class="alert alert-danger">${json.error}</div>`;
        title.textContent = 'Error';
        return;
      }
      const d = json.data;
      title.textContent = d.equipment;
      let html = `<p>Details for ${d.equipment}</p>`; // Build your modal content here
      body.innerHTML = html;
    })
    .catch(err => {
      body.innerHTML = '<div class="alert alert-danger">Failed to load details.</div>';
      title.textContent = 'Error';
      console.error(err);
    });
}

/* ====== Alerts live refresh ====== */
async function refreshAlerts() {
  try {
    const res = await fetch("{% url 'maintenance:alerts_json' %}");
    const data = await res.json();
    if (!data.ok) return;
    const container = document.getElementById('alertsContainer');
    if (!data.alerts.length) {
      container.innerHTML = '<p class="text-center text-muted mb-0">No active alerts ðŸŽ‰</p>';
      return;
    }
    let html = '';
    data.alerts.forEach(a => {
      const typeClass = a.type === 'Critical' ? 'alert-danger' : 'alert-warning';
      html += `<div class="d-flex justify-content-between align-items-start mb-2 alert ${typeClass}">
          <div>
            <strong>${a.title}</strong>
            <div class="small">${a.message || ''}</div>
            <div class="small text-muted">Created: ${a.created_at}</div>
          </div>
          <div class="text-end">
            <button class="btn btn-sm btn-outline-primary mb-1" data-equip-id="${a.id}" onclick="openEquipModal(this)">Details</button>
            <button class="btn btn-sm btn-success mb-1" onclick="ackAlert(${a.id}, this)">Acknowledge</button>
            <button class="btn btn-sm btn-secondary mb-1" onclick="dismissAlert(${a.id}, this)">Dismiss</button>
          </div>
        </div>`;
    });
    container.innerHTML = html;
  } catch (e) {
    console.error('Failed to refresh alerts', e);
  }
}

/* poll alerts every 30s */
setInterval(refreshAlerts, 30000);

// Ask Gemini button logic
document.getElementById('askBtn').addEventListener('click', async function() {
  const equipId = document.getElementById('equipSelect').value;
  const question = document.getElementById('aiQuestion').value.trim();
  const answerEl = document.getElementById('aiAnswer');
  if (!equipId) { alert('Select equipment first'); return; }
  if (!question) { alert('Type a question'); return; }

  answerEl.innerHTML = '<div class="text-muted">Thinking... <span class="spinner-border spinner-border-sm"></span></div>';

  try {
    const res = await fetch(`{% url 'maintenance:ask_gemini' 0 %}`.replace('0', equipId), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({question})
    });
    const data = await res.json();
    if (!data.ok) {
      answerEl.innerHTML = `<div class="text-danger">Error: ${data.error || 'Unknown'}</div>`;
    } else {
      answerEl.innerHTML = data.answer; // Assuming response is pre-formatted HTML/Markdown
    }
  } catch (err) {
    answerEl.innerHTML = '<div class="text-danger">Request failed.</div>';
    console.error(err);
  }
});
</script>
{% endblock %}
